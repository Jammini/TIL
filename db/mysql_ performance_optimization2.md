# 신뢰성 엔지니어링 환경에서의 모니터링

성공적인 고객 경험을 보장하기 위해 MySQL을 모니터링 하는데 필요한 다양한 방법을 살펴보자

# 측정대상

온라인 쇼핑의 증가로 인해 회사의 트래픽이 증가하고 있으며, DB계층이 증가된 수요를 감당할 수 있도록 인프라 그룹에 대한 요구가 있다. 무엇을 측정해야 하는지 보자

### SLI 및 SLO 정의

- SLI : 서비스 레벨 지표는 사용자가 시스템의 가용성을 경험하는 방식을 정량적으로 측정한 것입니다. 서비스 레벨의 성공 비율을 백분율로 나타낸다.
- SLO : 서비스 레벨 목표는 시스템에서 기대하는 가용성을 설정한 목표로, 일정 기간 동안의 백분율로 표시된다.

### 모니터링 솔루션

쿼리 응답 시간이 합의된 임곗값보다 길어지면 가능한 한 빨리 경고할 수 있는 도구에 의존

### 쿼리 지연 모니터링

모니터링 스택을 사용하여 MySQL 쿼리 실행에 걸리는 시간을 추적하여 완료시간까지도 클라이언트가 보고하게 해라.

### 오류 모니터링

데이터베이스 쿼리를 처리하는 서비스 전체에 걸쳐 발생하는 오류의 비율은 문제를 일으키는 중요한 지표가 될 수 있다.

아래는 일반적으로 사소한 해프닝일 수도 있지만 속도가 빨라지면 문제의 징후가 될 수 있는 클라이언트 측 오류

- Lock wait timeout

트랜잭션이 계속 재시도하고 여전히 실패하는 소스 노드의 행 잠금 경합이 증가하고 있다는 신호.

- Abortedconnections

클라이언트와 데이터베이스 인스턴스 사이에 있는 액세스 계층의 문제를 나타내는 지표가 될 수 있다.

### 사전모니터링

만족도를 높이기 위해 사전 예방적 모니터링 해라

예를 들어 100 % 꽉 찬 데이터베이스로 디스크 공간에 대한 알림은 서비스가 이미 중단된 상황이므로 늦지만 80%알림은 우리가 조치 가능하다.

### 디스크 증가

디스크 공간 증가에 대한 모니터링을 해라. 언제든지 필요한 확장을 계획하고 수행할 수 있는 여유 디스크 공간에 대한 임계값을 정해라.

### 연결 증가

max_connection을 설정하는 서버로 구성한 유한한 연결 풀을 지원해서 연결수가 최대에 도달하면 연결을 허용하지 않음.

- 애플리케이션 계층이 사용하지 않는 많은 연결을 열어 합당한 이유 없이 연결이 최대화될 위험이 있다

연결수(threads_connected)가 높은 것으로 표시되지만 threads_running은 여전 히 낮음

→ thread_connected / max_connections의 백분율은 애플리케이션 노드 수가 증가함에 따라 DB가 허용할 수 있는 최대 연결 풀에 얼마나 근접했는지 보여준다. 이 방법으로 모니터링 하는데 도움이 됨

- 애플리케이션 계층이 현재 많은 연결을 사용하고 있으며 데이터베이스에 과부하가 걸릴 위험이 있다.

threads_connected 및 threads_running이 모두 높은값

### 복제지연

레플리카 : 하나 이상의 추가 서버로 데이터를 보내는 기본 복제 기능

원본에 기록 중인 데이터와 레플리카에서 사용 가능한 데이터 사이의 지연을 복제 지연이라고함.

복제지연을 방지하기 위한 전략은 9장에서..

### I/O 활용

디스크 I/O 활동을 모니터링하면 성능 저하가 고객에게 나타나기 전에 미리 대처할 수 있다.

iostat와 같은 도구를 사용해 I/O 대기 상태를 모니터링 할 수 있음.

IOwait에 스레드가 많다면, 스레드들이 일부 디스크 리소스가 사용 가능해질 때를 기다리는 대기열에 있다는 것을 알려주기 원한다.

IOutil을 하루나 이틀, 일주일 등 기간동안의 실행 그래프를 통해 추적해준다.

IOutil은 전체 시스템 디스크 액세스 용량의 백분율로 보고된다.

디스크 I/O 용량의 전체 활용률을 백분율로 모니터링하면 디스크 액세스가 DB성능에 향후 병목 현상을 유발하는 것을 방지할 수 있음.

### 자동 증가 공간

자동 증가 기본 키가 기본적으로 부호를 가진 정수로 생성되어 키 공간이 부족할 수 있다.

이 문제는 자동 증가 키가 가능한 최댓값에 도달할 정도로 충분히 삽입된 경우에 발생한다.

즉, 모니터링을 통해 장동 증분을 기본키로 사용하는 모든 테이블에 대해 남은 정수 공간을 모니터링해야함.

어떻게 하냐?

PMM과 Prometheus exporter를 사용하고 있다면 기본 제공되는 -collect.auto_increment.columns 플래그를 켜기만 하면 된다.

Prometheus를 사용하지 않는다면 쿼리를 사용할 수 있다. → 38페이지 참고

6장에서 더 다룸.

### 백업 생성/복원 시간

장기적인 계획은 비즈니스가 정상적으로 운영되는 동안의 데이터 증가에 대한 것뿐만 아니라 허용되는 시간 내에 복구하는 것을 포함한다. 

샤딩 & 파티셔닝 : 데이터 확장을 위해 별도의 인스턴스에서 데이터를 분할하는 방법

기능적 샤딩 : 데이터 세트의 가동 시간, 성능 또는 액세스 제어를 별도로 관리하기 위해 특정 비즈니스 기능을 수행하는 특정 테이블을 전용 클러스터로 분할하는 것을 의미한다.

수평적 샤딩 : 단일 클러스터에서 안정적으로 제공할 수 있는 크기 이상으로 데이터 세트가 증가한 경우, 이를 여러 클러스터로 분할하여 여러 노드의 데이터를 제공하고 필요한 하위 집합을 찾는 조회 메커니즘에 따라 데이터를 제공하는 것.

# 장기적인 성능 측정

### 비즈니스 케이던스 배우기

DB가 몰릴거 같은 날을 예상하고 인식해라

### 효과적인 메트릭추적

장기적으로 성능향상 또는 저하 추세 파악해라.

- 미래 용량 산정
- 주요 개선이 필요한 시기와 점진적인 변화로도 충분한 시점 예측
- 인프라 운영 비용증가에 대한 계획 수립

### 성능 점검을 위한 모니터링 도구 사용

도구가 이러한 종류의 장기적인 추세에 적합한지 판단할 때 고려해야 할 몇가지 중요한 기능과 측면을 보자

1. 평균을 맹신하지 마라

평균 데이터 지점의 그래프는 잘못된 보안 정보를 줄가능성이 높다 월별 데이터를 추세화할 때 항상 최고점을 확인해야 뷰에서 간헐적으로 급증하는 데이터의 정확도를 유지할 수 있다.

2. 백분위수는 여러분의 친구다

시각적으로 우수하며 엔지니어링 팀뿐만 아니라 고객지원과 같은 인력도 DB 메트릭을 이해할 수 있다.

3. 긴 보존 기간 및 성능

긴 시간 범위를 표시하려고 할대 모니터링 도구의 성능이 중요하다

### 전체 아키텍처링에 SLO활용하기

비지니스 규모가 커짐에 따라 동일한 SLO라도 유지하는 것이 점점 더 어려워진다.

SLI 및 SLO를 사용하면 데이터를 기능적 샤딩 또는 데이터 파티션으로 분할하는 것이 적합한 성장 지점을 찾을 수 있다.

### 요약

지표와 목표를 지속해서 개선하고 재검토하는 것은 데이터베이스 인프라 모니터링에 신뢰성 엔지니어링 개념을 적용하는 과정에서 중요하다.

항상 고객 경험을 나타내는데 중점을 두고 있는 메트릭을 선택하고 목표를 할당할 때 주의해라.

사고가 발생한 시점을 보여주는 지표에만 모든 노력을 집중하지 말고 사고를 예방 하는데 도움이 될 수 있는 사항아르 모니터링하는데 시간을 할애해라.