# 10장 백업 및 복구

MySQL과 관련된 부분만 다루지만 전체 백업 및 복구 전략에는 포함해야 하는 몇가지 사항은 다음과 같다.

- 보안(백업에 대한 액세스, 데이터 복원 권한 및 파일 암호화 필요 여부)
- 원본에서 얼마나 멀리 떨어져 있어야 하는지(다른 디스크, 다른 서버 또는 외부의 장소)와 원본에서 대상으로 데이터를 이동하는 방법을 포함한 백업을 저장할 위치
- 보존 정책, 감사, 법적 요구 사항 및 관련주제
- 스토리지 솔루션 및 미디어, 압출 및 증분 백업
- 저장 형식
- 백업 모니터링 및 보고
- 스토리지 계층 또는 사전 제작된 파일 서버와 같은 특정 장치에 내장된 백업 기능

복원 : 백업에서 데이터를 검색하여 MySQL에 로드하거나 MySQL이 예상하는 위치에 파일을 배치하는 것을 의미한다.

복구 : 일반적으로 문제가 발생한 후 시스템 또는 시스템의 일부를 되살리는 전체 프로세스를 의미한다.

물리적 백업, 원시백업 : 파일 시스템의 파일 복사본

논리적 백업 : 데이터를 재구성하는데 필요한 SQL문

# 백업을 하는 이유

백업이 중요한 몇가지 이유는 다음과 같다.

- 재해복구
- 마음을 바꾸는 사람들
- 감사
- 테스팅

# 복구 요구 사항 정의

- 백업이 우선이다. 먼저 백업하지 않으면 복구할 수 없으므로 시스템을 구축할 때 자연스럽게 백업에 관심이 집중된다.
- 백업은 스크립트와 작업으로 자동화된다.
- 백업은 일상적이지만 복구는 대부분 위기 상황에 수행한다.
- 보안이 방해가 될 수 있다.
- 여러 사람을 교육하고 적용 범위의 계획을 세워야 한다.

백업 및 복구 전략을 계획할때 고려해야 할 두가지 중요한 요구사항이 있다. RPO(복구 시점 목표)와 RTO(복구 시간 목표)가 있다. RPO, RTO를 정의할 때 다음과 같은 질문에 답해보아라.

- 심각한 결과를 초래하지 않고 얼마나 많은 데이터를 잃을 수 있는가? 특정 시점 복구가 필요한가? 아니면 마지막 정기 백업 이후 발생한 모든 작업을 손실해도 괜찮을까? 법적 요구 사항이 있는가?
- 얼마나 빨리 복구해야 하나? 어쩐 종류의 다운타임이 허용되나? 애플리케이션 및 사용자가 수용할 수 있는 영향은 무엇이며, 이러한 시나이로가 실제로 발생할 때 기능을 계속하기 위해 어떻게 구축하겠는가?
- 회복해야 할 것은 무엇인가? 일반적으로 전체서버, 단일 데이터베이스, 단일 테이블, 특정 트랜잭션이나 명령문을 복구해야 한다.

이러한 질문에 대한 답변과 전체 백업 정책 및 백업 절차를 문서화하는것이 좋다.

# MySQL 백업 솔루션 설계

백업은 데이터의 복사본일 뿐이지만 애플리케이션의 요구사항, MySQL의 스토리지 엔진아키텍처 및 시스템 구성 때문에 데이터 복사본을 만들기 어려울 수 있다.

- 원시 백업은 실제 대규모 데이터베이스에 필수이다. 논리적 백업은 너무 느리고 리소스가 많이 소모되며 복구하는데 오래걸린다.
- 다양한 시점의 백업을 유지한다.
- 논리적 백업을 주기적으로 추출한다.
- 특정 시점 복구를 위해 바이너리 로그를 보관한다.
- 백업 도구 자체와 별도로 백업 및 백업 프로세스를 모니터링한다. 문제가 없는지 외부의 확인이 필요하다.
- 전체 복구 프로세스를 통해 백업 및 복구 프로세스를 테스트 한다. 복구에 필요한 리소스(CPU, 디스크 공간, 시간, 네트워크 대역폭 등)를 측정한다.
- 보안에 대해 생각해라.

일반적으로 손실을 감당할 수 있는 양이 많을 수록 백업을 수행하기 쉽다. 하지만 손실을 결코 용납할 수 없을 것이다. 이를 위해 별도의 SAN 볼륨에 바이너리 로그를 유지하거나 DRDB 디스크 복제를 사용하는 것과 같은 특별한 기술이 필요하다.

### 온라인 백업 또는 오프라인 백업

MySQL을 종료하고 백업을 만드는 것이 손상이나 불일치의 위험을 최소화하면서 일관된 데이터 복사본을 얻는 가장 쉽고 안전하면 최선의 방법이다. 그러나 서버를 오프라인으로 전환하는 것은 비용이 많이 든다.

백업을 계획할 때 고려해야 할 몇가지 성능 관련요소는 다음과 같다.

1. 백업 시간
    - 백업을 만들고 대상에 복사하는 데 시간이 얼마나 걸리나?
2. 백업 부하
    - 백업을 대상에 복사하면 서버 성능에 어느 정도 영향을 주나요?
3. 복구 시간
    - 백업 이미지를 저장 위치에서 MySQL 서버로 복사하고 바이너리 로그를 재생하는 등의 작업에 시간이 얼마나 걸리나?

가장 큰 트레이드 오프는 백업시간 대 백업 부하이다.

### 논리적 백업 또는 원시 백업

MySQL의 데이터를 백업하는 데는 논리적 백업(덤프라고도 함)과 원시 파일 복사의 두가지 주요 방법이 있다.

**논리적 백업**

MySQL이 SQL 또는 구분된 텍스트로 해석할 수 있는 형식의 데이터가 포함된다.

장점

- grep 및 sed와 같은 커맨드 라인과 편집기로 조작하고 검사할 수 있는 일반 파일이다. 데이터를 복원하거나 복원하지 않고 데이터를 검사하려는 경우에 매우 유용할 수 있다.
- 복구가 간단하다.
- MySQL 호스트와 다른 시스템에서 네트워크를 통해 백업 및 복원할 수 있다.
- 기본 파일시스템에 액세스 할 수 없는 클라우드 기반 MySQL 시스템에서 사용할 수 있다.
- mysqldump가 백업할 행을 제한하는 WHERE 절과 같은 많은 옵션을 허용할 수 있기에 유연하다.
- 스토리지 엔진과 독립적이다. MySQL 서버에서 데이터를 추출하여 생성하기에 기본 데이터 저장소의 차이점을 추상화한다.
- 데이터 손상을 방지할 수 있다.

단점

- 서버에서 생성하는 작업을 수행하므로 더 많은 CPU 주기를 사용한다.
- 데이터를 덤프하고 복원한다고 해서 항상 동일한 데이터가 생성되는 것은 아니다. 부동 소수점 표현 문제 버그 등이 드물기는 하지만 문제가 생기기도 한다.
- 논리적 백업에서 복원하려면 MySQL이 명령문을 로드 및 해석하고 저장소 형식으로 변환하고 인덱스를 재구성해야 하며 이 모든 작업이 매우 느리다

가장 큰 단점은 실제로 MySQL에서 데이터를 덤프하는 비용과 SQL 문을 통해 데이터를 다시 로드하는 비용이다. 논리적 백업을 사용하는 경우 데이터 복원에 필요한 시간을 테스트하는 것은 필수이다.

**원시 파일**

디스크에 있는 그대로의 파일이다.

장점

- 원시 파일 백업은 백업을 위해 원하는 파일을 다른 곳에 복사하기만 하면 된다. 원시 파일을 생성하는데 추가 작업이 필요없다.
- 플랫폼, 운영체제 및 MySQL 버전 간에 이식성이 높다.(논리적 덤프도 마찬가지다)
- MySQL 서버가 SQL을 실행하거나 인덱스를 구축할 필요가 없기 때문에 원시 백업을 복원하는 것이 더 빠를 수 있다.

단점

- InnoDB의 원시 파일은 해당 논리적 백업보다 훨씬 큰 경우가 많다. InnoDB 테이블스페이스는 일반적으로 사용하지 않는 공간이 많다. 테이블 데이터 저장 이외의 용도로도 상당히 많은 공간이 사용된다.
- 원시 백업이 플랫폼, 운영 체제 및 MySQL 버전 간에 항상 이식 가능한 것은 아니다. 파일 이름 대소문자 구분 및 부동 소수점 형식에서 문제가 발생할 수 있다.

원시 백업은 일반적으로 더 쉽고 더 효율적이다. 하지만 장기 보존이나 법족 요구사항에 원시 백업을 사용해서는 안된다. 최소한 주기적으로 논리적 백업을 수행해야 한다.

### 백업 대상

MySQL 백업에 포함할 수 있는 백업 대상은 다음과 같다.

- 불분명한 데이터
    - 바이너리 로그와 InnoDB 트랜잭션 로그, MySQL용 전체 데이터 디렉터리
- 코드
    - 트리거 및 스토어드 프로시저와 같은 많은 코드
- 서버 구성
    - 서버의 구성 파일
- 선택한 운영체제 파일
    - 실 운영 서버에 필수적인 외부 구성 백업

### 증분 백업 및 차등 백업

너무 많은 데이터를 처리하기 위한 일반적인 전략은 증분 또는 차등 백업을 정기적으로 수행하는 것이다.

차등 백업 : 마지막 전체 백업 이후 변경된 모든 백업

증분 백업 : 모든 유형의 마지막 백업 이후 변경된 모든 것을 포함

### 복제

레플리카에서 백업할 때의 가장 큰 장점은 원본에 영향을 미치거나 추가 부하를 가하지 않는것이다. 로드 밸런싱이나 고가용성을 위해 필요하지 않더라고 레플리카 서버를 성정하는 좋은 이유이다. 레플리카에서 백업을 만들때 GTID를 사용하는 것이 좋다. 

# 바이너리 로그 관리 및 백업

서버의 바이너리 로그는 백업할 수 있는 가장 중요한 것 중 하나이다. 특정 시점 복구에 필요하며 일반적으로 데이터보다 크기가 작기 때문에 자주 백업할 수 있다.

바이너리 로그를 자주 백업하는 것이 좋다. 30분 이상의 데이터 손실을 용납할 수 없다면 30분마다 백업해야 한다.

# 백업과 복구 도구

원시 백업의 경우 Percona XtraBackup을 권장한다. 오픈 소스이며 널리 사용되며 문서화가 잘되어 있다.

논리적 백업의 경우 mydumper를 추천한다. mydumper는 단일 스레드 특성상 백업 및 복원 시간이 길어 질 수 있다. 병렬처리가 내장되어 있어 논리적 백업을 훨씬 더 빠르게 수행할 수 있다.

### MySQL 엔터프라이즈 백업

MySQL용 공식 백업 도구 이다. MySQL을 중지하거나 잠금을 설정하거나 정상적인 데이터베이스 활동을 중단할 필요없다. 압축 백업, 증분 백업 및 다른 서버로의 스트리밍 백업과 같은 기능을 지원한다.

### Percona XtraBackup

MySQL 엔터프라이즈 백업과 유사하지만 오픈소스이고 무료이다. 스트리밍, 증분, 압축 및 멀티스레드(병렬) 백업 작업과 같은 기능을 지원한다. 또한 부하가 높은 시스템에 대한 백업의 영향을 줄일 수 있는 다양한 특수 기능을 갖추고 있다.

백그라운드 스레드에서 InnoDB 로그 파일을 ‘추적(tailing)’한 다음 InnoDB 데이터 파일을 복사하는 방식으로 작동한다.

### mydumper

MySQL엔지니어들이 mysqldump를 대체하기 위한 mydumper를 만들었다.

다양한 기능이 포함된 MySQL 용 멀티 스레드(병렬) 백업 및 복원 도구 세트이다.

### mysqldumper

MySQL과 함게 제공되는 프로그램을 사용하므로 단점에도 불구하고 데이터 및 스키마의 논리적 백업을 생성하는 일반적인 도구이다.

# 데이터 백업하기

네트워크, 디스크 및 CPU 용량을 최대화하여 최대한 빨리 백업하는 것이다. 

### 논리적 SQL 백업

논리 SQL덤프는 기본적으로 mysqldump가 생성하는 것이기 때문에 익숙하다.

mysqldump의 기본 옵션은 대용량 백업에 적합하지 않는다.

논리적 백업을 사용해야 하는 경우 mydumper를 살펴보고 단일 스레드 특성을 피하기 위해 백업을 수행할 때 데이터베이스에 미치는 영향을 측정하는 것이 좋다.

### 파일시스템 스냅숏

온라인 백업을 만드는 좋은 방법이다. 스냅숏 지원 파일시스템은 해당 콘테츠의 일관된 이미지를 즉시 생성하여 백업에 사용할 수 있다. 

스냅숏을 만드는 것은 단순히 잠금을 유지해야 하는 시간을 단축하는 방법이다. 잠금을 해제한 후에 파일을 백업에 복사해야 한다.

**LVM 스냅숏 작동방식**

copy-on-write 기술을 사용하여 스냅숏, 즉 한 번에 전체 볼륨의 논리적 복사본을 생성한다. 데이터의 이전버전을 하나만 유지한다는 점을 제외하면 데이터베이스의 MVCC와 약간 비슷하다. 

### Percona XtraBackup

MySQL 백업을 위한 가장 인기 있는 솔루션 중 하나이다. 압축되고 암호화된 파일을 백업하는 방법을 포함해 매우 쉽게 구성할 수 있다.

**XtraBackup 작동방식**

MySQL에서 충돌이 발생하면 redo 로그를 기반으로 하는 충돌 복구 모드를 통해 데이터를 다시 온라인 상태로 전환한다. LSN(로그 시퀀스 번호)을 기록하고 이를 사용하여 백업된 파일을 기반으로 충돌 복구를 수행한다. 또한 복제에 대한 데이터가 데이터와 일치하도록 특정 지점에서의 잠금이 포함되어 있다.

# 백업에서 복구하기

데이터를 복구하는 방법은 백업 방법에 따라 달라진다. 다음 단계 중 일부 또는 전부를 수행해야 할 수 있다.

1. MySQL 서버를 중지한다.
2. 서버의 구성 및 파일 사용권한을 기록한다.
3. 백업의 데이터를 MySQL 데이터 디렉토리로 이동한다.
4. 구성을 변경한다.
5. 파일 권한을 변경한다.
6. 제한된 액세스로 서버를 재시작하고 완전히 시작될 때까지 기다린다.
7. 논리적 백업 파일을 다시 로드한다.
8. 바이너리 로그를 검사하고 재생한다.
9. 복원한 내용을 확인한다.
10. 전체 액세스 권한으로 서버를 재시작한다.

### 논리적 백업 복원

MySQL 서버 자체에서 데이터를 테이블로 다시 로드해야 한다.

### 스냅숏에서 원시파일 복원

일반적인 절차는 단순히 파일을 제자리에 복사하는 것이다. 모든 테이블이 단일 스페이스에 저장되는 기존 InnoDB 설정을 복원하는 경우 MySQL을 종료하고 파일을 복사하거나 이동한 다음 다시 시작해야 한다. 또한 InnoDB의 트랜잭션 로그 파일이 테이블스페이스 파일과 일치하는지 확인해야 한다.

원시 파일을 복원하는 작업이 잘못되기 쉬우므로 문제가 발생하여 원시 백업을 사용할 수 없는 경우를 대비해 논리적 백업을 준비하는 것이 좋다.

### Percona XtraBackup으로 복원 하기

InnoDB의 충돌 복구 프로세스를 사용하여 안전한 백업을 수행한다.

xbstream 명령으로 압축을 풀고 위치로 지정한다.

작업이 완료되면 data-dir 변수를 자동으로 감지하고 파일을 올바른 위치로 이동한다.

### 원시 파일 복원 후 MySQL 시작하기

가장 중요한 것은 MySQL 서버를 시작하기 전에 서버 구성을 확인하고 복원된 파일에 올바른 소유자와 권한이 있는지 확인하는 것이다. 이러한 속성은 정확히 맞아야 한다.

### 요약

백업이 필요하다는 것은 누구나 알고 있지만 복구 가능한 백업이 필요하다는 것을 모두가 알고 있지 않는다.

정기적으로 복구를 테스트하고 제대로 작동하는지 확인해라.

레플리카가 백업이라는 생각의 함정에 빠지지마라.

결론적으로 백업을 수행할 때 선호하는 방법은 원시 백업에는 Percona XtraBackup 을 사용하고 논리적 백업에는 mydumper를 사용하는 것이다. 두 가지 방법을 모두 사용하여 서로 방해받지 않고 데이터의 바이너리 백업을 수행할 수 있다.