# 12장 클라우드에서의 MySQL

# 관리형 MySQL

퍼블릭 클라우드에는 관리되는 SQL 데이터베이스의 모양과 작동방식에 자체적인 해석이 있다. AWS → Aurora MySQL / GCP → Cloud SQL

관리 솔루션의 주요 장점은 MySQL 세부 사항에 대해 자세히 알아볼 필요 없이 액세스 가능한 데이터베이스 설정을 제공한다는 것이다.

몇 번의 클릭 또는 테라폼을 적용하기만 하면 레플리카 및 예약된 백업과 함께 데이터베이스를 온라인으로 사용할 수 있다. 

장점 : 빠른 시작을 원하는 회사나 팀에게 매우 유리하다.

단점 : 가시성과 제어가 부족하다. 운영체제나 파일시스템에 액세스할 수 없으며 프로세스 내에서 수행할 수 있는 작업이 제한된다. 고급 토폴리지는 설정할 수 없고 백업 및 복원 방법은 클라우드 공급자가 제공하는것으로 제한.

### MySQL용 Amazon Aurora

MySQL 호환 호스팅 테이터베이스이다. Aurora는 컴퓨팅을 스토리지에서 분리하여 개별적으로 더 유연하게 확장할 수 있다.

Aurora는 스냅숏 백업수행, 빠른 스키마 변경관리, 감사로깅, 단일 리전 내 복제 관리와 같이 일반적으로 처리해야 하는 여러 운영 작업을 관리한다.

```

'MySQL 호환 가능'은 MySQL의 주요 버전을 확인해야 한다. Aurora의 호스팅 솔루션은 MySQL 8.0과 호환되지 않으며
이전 솔루션 중 일부는 MySQL 5.6만 호환된다. 이전을 고려하고 있다면 실운영 데이터를 이동하기 전에 테스트해서 확인해라.
```

<img width="526" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/b97638ce-0702-4a8d-924d-aa223a307dc3">


위 그림은 사용자의 요구 사항에 적합하고 어떤 트레이드 오프에서 가장 적합한지 Aurora를 선택하는데 도움이 되는 순서도이다.

### GCP Cloud SQL

이 서비스와 AWS 서비스의 핵심 차이점은 커뮤니티 서버를 실행하지만 제품의 멀티테넌시 및 관리 측면을 허용하기 위해 특정 기능이 비활성화되어 있다는 것이다.

커뮤니티 서버를 실행하지만 Cloud SQL과 함께 사용할 수 없는 몇가지 사항은 다음과 같다.

- SUPER 권한 비활성화
- 플러그인 로딩 비활성화
- Mysqldump, mysqlimport와 같은 일부 클라이언트도 비활성화

AWS의 ㅅ서비스와 마찬가지로 인스턴스에 대한 SSH 액세스 권한을 얻을 수 없다. 반명 Cloud SQL에서 관리하는 여러 운영작이 있다.

- 기본 고가용성을 지원합니다. 페일오버는 구성 옵션을 사용하여 자동화된다.
- 저장 데이터의 기본 암호화를 처리한다.
- 여러 방법을 사용하여 유연하게 업그레이드 관리한다. 궁극적으로 이러한 유지 관리 기간에는 약간의 다운타임이 포함되어 이를 애플리케이션 SLO와 균형을 맞추는 것은 사용자의 책임이다.

클라우드 공급자가 제공하는 관리 옵션이 무엇인지와 사용 방법을 알아야 할 가능성이 높다. 또는 관리형 MySQL대신 VM을 직접 사용하도록 전환해야 한다.

# 가상 머신의 MySQL

VM에서 MySQL을 실행하는 것은 다음과 같은 이유가 있다.

- 모든 운영 측면을 완벽하게 제어할 수 있다.
- 단일 리전에서 기본 MySQL을 실행할 수 있지만 재해 복구 목적으로 다른 지역에 레플리카를 설정하거나 시간지연 레플리카를 실행할 수 있다.
- 워크로드에 가장 적합하도록 백업 방법을 조정할 수 있다.
- 성능이 저하되거나 문제가 발생하면 운영체제와 파일시스템을 완전히 제어할 수 있으므로 원하는 모든 검사를 수행할 수 있다.

## 클라우드의 머신 유형

클라우드 공급자를 사용하면 워크로드에 맞게 시스템 사양을 최적화하는 것이 훨씬 쉬어진다. 클라우드 제공업체를 통해 vCPU(가상 CPU), 사용 가능한 RAM 크기, 네트워킹 및 디스크 제한을 설정하는 시스템 사양을 선택할 수 있다. 따라서 워크로드 변화에 따라 VM 크기를 조정할 수 있다.

즉, 연말연시와 같이 트래픽이 최고조에 달할 경우를 감안하여 컴퓨터 사양을 일시적으로 늘리수 있다. 이러한 유연성으로 인행 많은 사람들이 클라우드로 전환한다.

## 올바른 머신 유형 선택

클라우드를 이용할 경우 vCPU, 메모리 또는 네트워크 병목 발생하는 경우 크기를 조정 가능

데이터 센터의 경우 올바른 구성을 미리 결정하는 것이 어렵다.

### CPU

vCPU 수 공식 (코어수 X 95% 총 CPU 사용량) X 2

ex) 데이터센터에 40코어 서버가 있다고 가정. 지난 30일 동안 최대 CPU사용량은 30%

클라우드 공급자에서 50% 사용률로 실행하려면 몇개의 코어가 필요한가?

(38 * 30%) * 2 = 24코어

트래픽이 많은 웹 애플리케이션을 실행하는 경우 최신 세대의 칩을 사용하고 오래된 데이터 처리방식이라면 약간 느린 CPU칩으로 비용정감해라.

### 메모리

적정하지 않은 과도한 RAM용량으로 오류를 범하지 않도록 작업 데이터 셋에 가장 적합한 시스템 사양을 선택해라.

### 네트워크 성능

네트워크 성능의 한계도 검토하여 애플리케이션이 부족하지 않도록 해야한다.

## 올바른 디스크 유형 선택

디스크 유형을 선택하고 데이터에 사용하기 시작하면 다른 디스크 유형으로 이동하기 어려워진다. 일반적으로 두번째 디스크를 마운트하고 데이터를 복사해야 한다.

읽기 집약적인 워크로드는 메모리 액세스가 훨씬 더 빠르기 때문에 디스크 성능보다 더 많은 메모리를 활용할 수 있다. 작업세트가 InnoDB 버퍼 풀보다 크면 항상 디스크로 이동하여 데이터를 읽게 된다.

쓰기 집약적 워크로드는 항상 디스크로 이동하며 대부분의 사용자가 디스크 병목현상을 경험한다.

### 첨부 파일 유형

가장 먼저 결정해야 할 사항은 로컬로 연결된 디스크를 사용할지, 아니면 네트워크에 연결된 디스크를 사용할지이다. 

로컬로 연결된 디스크는 놀라운 성능과 일관된 처리량을 제공하지만 데이터 손실에 취약하다.

네트워크 연결 디스크는 성능보다 중복성과 안정성을 제공하므로 다른 방향으로 이동한다. 네트워크 연결 디스크는 로컬로 연결된 디스크가 아닌 경우 지연이 발생할 수 있다.

### SSD 대 HDD

일반적으로 MySQL 데이터 볼륨에 SSD를 사용하고자 할 것이다. 예산이 빠듯하다면 부팅 디스크를 위한 저렴한 옵션으로 HDD를 검토해라.

### IOPS와 처리량

필요한 디스크 유형을 선택하기 전에 이러한 각 요구 사항이 어떻게 되는지 과거 및 미래 예측에 대해 잘 이해하고 있어야 한다.

기존 워크로드에서 마이그레이션하는 경우 디스크를 잘 선택할 수 있는 디스크 사용량 측정 기준을 이미 가지고 있는 것이 이상적이다. 그렇지 않은 경우 Percona Toolkit패키지의 pt-disckstats를 사용하여 하루 동안의 메트릭을 수집하여 피크를 측정해라.

## 추가적인 팁

VM에서 자체 MySQL을 실행하기로 한 경우 관리형 서비스 그 이상을 담당한다. 디스크 스케일링, 백업 등과 같은 작업을 직접 수행한다.

### 호스팅 재부팅처리

실 운영 트래픽을 처리하는 동안, 특히 쓰기를 수행하는 소스 노드에서 재부팅 처리가 되면 사용자의 업무 중단이 발생할 수 있다.

이런 일이 발생하면 레플리카에 대한 장애 조치 프로세스를 시잣하거나 소스가 다시 온라인 상태가 될 때까지 기다니는 두가지 옵션이 있다. 계획되지 않은 프로모션을 처리하는 것은 매우 까다로울 수 있기에 서버가 다시 온라인 상태가 되고 복제가 자연스럽게 연결되도록 허용하는 것이 좋다.

- 가능한 한 빨리 재부팅할 수 있도록 SSD 부팅 디스크를 사용한다. 대부분의 시스템은 5분 이내에 다시 온라인 상태가 된다.
- 시스템이 완전히 재부팅되고 정상 상태가 되도록 최대 5분 동안 호스트 다운 호출 알림을 표시하지 않는다.
- 소스 서버가 재부팅된 경우 read_only 플래그를 동적으로 해제하는 옵션을 코딩하여 사용자의 개입 없이 쓰기를 계속할 수 있다.
- 중단을 인식해야 할 팀이나 채널에 이메일이나 채팅 메시지를 자동으로 전송하여 커뮤니케이션을 최대화한다.

### 별도의 운영 체제 및 MySQL 데이터

로컬 연결 또는 네트워크 연결중 어느 것을 선책하든 상관없이 MySQL 데이터를 별도로 유지하는 것이 좋다

- 디스크 스냅숏은 MySQL 데이터로만 제한되며 운영 체제 정보는 포함되지 않는다
- 네트워크에 연결된 디스크의 경우 디스크 연결을 끊었다가 다른 시스템에 쉽게 다시 연결할 수 있다.
- 또한 네트워크 연결 디스크의 경우 파일시스템에 데이터를 다시 복사할 필요 없이 운영 체제를 업그레이드하거나 교체할 수 있다.

로그가 데이터 디스크에 남아 있을 수 있지만 운영체제에 두는 것이 좋다.

### 바이너리 로그 백업

바이너리 로그를 버킷으로 보낸다. 버킷에 수명주기 제어를 설정하여 특정 기간이 경과한 후 오래된 파일을 자동으로 제거한다. 마찬가지로 특정 기간 이전에 파일 삭제를 방지하거나 아예 삭제를 금지한다.

### 디스크 자동 확장

네트워크 연결 디스크를 사용하면 사용되지 않은 프로비저닝된 공간에 대해 비용을 지불한다.

MySQL 데이터 디스크에 프로비저닝되었지만 사용되지 않은 공간을 남겨두는 것은 낭비라는 것을 의미한다.

클라우드 제공자는 일반적으로 디스크 크기를 확장하는데 사용할 수 있는 API 호출을 제공한다. 약간의 코드로 서버가 90% 디스크로 가득 차 있다는 표시를 넘고 있는 확인하고 해당 API를 호출하여 디스크를 확장할 수 있다.

주의 사항은 다음과 같다.

- 사용된 디스크 공간 백분율을 찾는 코드를 얼마나 자주 실행해야하는지 생각해라.
- 디스크 확장 API 호출로 인해 디스크가 잠시 중단될 수 있다. 부하상태에서 테스트하여 사용자에게 영향을 미치지 않도록 해라.

# 요약

모든 옵션에는 트레이드 오프가 포함되어 있다. 가장 유용한 방법은 조직에게 가장 적합한 방향으로 비즈니스 운영 방식과 비즈니스 성숙도 단계에 따라 이러한 트레이드 오프를 구체화하는 것이다.
