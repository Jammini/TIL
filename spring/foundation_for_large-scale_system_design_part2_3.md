# 3장 구글 맵

구글 맵은 웹 기반 지도 서비스이며 위성 이미지, 거리 뷰, 실시간 교통상황, 경로계획등 다양한 서비스를 제공하고 있다.

## 1단계: 문제 이해 및 설계 범위 확정

### 기능 요구사항

- 사용자 위치 갱신
- 경로 안내 서비스(ETA 서비스 포함)
- 지도 표시

### 비기능 요구사항 및 제약사항

- 정확도: 사용자에게 잘못된 경로를 안내하면 안된다.
- 부드러운 경로 표시: 클라이언트를 통해 제공되는 경로 안내 용도의 지도는 화면에 아주 부드럽게 표시되고 갱신되어야 한다.
- 데이터 및 배터리 사용량: 클라이언트는 가능한 한 최소한의 데이터와 배터리를 사용해야 한다. 모바일 단말에 아주 중요한 요구사항이다.
- 일반적으로 널리 통용되는 가용성 및 규모 확장성 요구사항을 만족해야 한다.

### 개략적 규모 추정

설계 초점이 모바일 단말이므로 데이터 사용량과 배터리 효율을 중요하게 따져야 함.

- 1피트 = 0.3048미터
- 1km = 0.6214마일 = 1,000미터

**저장소 사용량**

1. 세계 지도
2. 메타데이터
3. 도로 정보

1. 세계 지도

지도를 최대한 확대하여 보는 데 필요한 타일 개수를 따져본다.

위 계산과 달리, 인간이 살지 않는 자연(바다, 사막, 호수, 산간) 지역들은 80 ~ 90% 저장용량 절감 할 수 있다.

1. 서버 대역폭

서버가 처리해야 하는 요청은 크게 두가지다.

첫번째는 경로 안내 요청으로 클라이언트가 경로 안내 세션을 시작할 때 전송하는 메시지다.

두번째는 위치 갱신 요청으로 클라이언트가 경로 안내를 진행하는 동안 변경된 사용자 위치를 전송하는 메시지다.

GPS좌표를 매초 전송하면 요청건이 많아지고 QPS가 굉장히 높아지기에 클라이언트쪽에서 요청을 모아두었다가 덜 자주 보내도로(ex 15초 → 30초마다 한번씩) 쓰기 QPS를 낮출 수 있을 것이다.

## 2단계: 개략적 설계안 제시 및 동의 구하기

### 개략적 설계안

<img width="532" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/52b460ca-8a3e-48fc-8386-b0c52d0b2811">


아래 세가지 기능을 제공한다.

1. 위치서비스(location service)
2. 경로 안내 서비스(navigation service)
3. 지도 표시(map rendering)

### 1. 위치 서비스

사용자의 위치를 기록하는 역할.

<img width="319" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/2a62edc6-52c9-4073-846e-fe7978ab0f86">

클라이언트가 t초마다 자기 위치를 전송한다고 가정한다. 주기적으로 위치 정보를 전송하면 장단점이 있다.

- 장점
    
    해당 데이터 스트림을 활용하여 시스템을 점차 개선할 수 있다는 점.
    

ETA(도착 예정 시간)를 좀 더 정확하게 산출할 수 있고, 교통 상황에 따라 다른 경로를 안내할 수도 있다는 점.

- 단점
    
    클라이언트가 보내는 요청이 계속되면 많은 양으로 인해 부하가 발생한다.
    

책에서는 쓰기 요청 빈도에 최적화된 카산드라 데이터베이스를 추천한다. 통신 프로토콜로는 HTTP를 keep-alive옵션과 함께 사용하면 효율을 높일 수 있다.

### 2. 경로 안내 서비스

A에서 B지점으로 가는 합리적으로 빠른 경로를 찾아 주는 역할 담당.

계산된 경로는 최단 시간 경로일 필요는 없으나 정확도는 보장 되어야함.

### 3. 지도 표시

지도 타일을 다 가지려면 수백 PB가 필요하나 클라이언트가 가지는 것은 실용적이지 않다.

따라서, 서버가 가져오는 접근법이 바람직한데, 클라이언트는 언제 지도 타일을 서버에서 가져오는가?

- 사용자가 지도를 확대 또는 이동시키며 주변을 탐색한다.
- 경로 안내가 진행되는 동안 사용자의 위치가 현재 지도 타일을 벗어나 인접한 타일로 이동한다.

**선택지1**

클라이언트의 위치, 현재 클라이언트가 보는 지도의 확대 수준에 근거해 필요한 지도 타일을 즉석으로 만드는 방안. → 위치 및 확대 수준의 조합으로 인한 심각한 문제

- 모든 지도 타일을 동적으로 만들어야 하는 서버 클러스터에 심각한 부하가 걸리는 문제
- 캐시를 활용하기 어렵다.

**선택지2**

확대 수준별로 미리 만들어 둔 지도 타일을 클라이언트에 전달하기만 하는 방법.

미리 만들어 둔 정적 이미지를 CDN에 두어 사용자에게 반환하게 한다.

규모 확장에 용이하고 성능 측면에서도 유리하다.

<img width="390" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/3380972c-faf2-4abe-8611-c1ff67cf8f53">


1. 모바일 사용자가 타일 URL들을 가져오기 위해 지도 타일 서비스를 호출한다. 이 요청은 로드밸런서로 전달된다.
2. 로드밸런서는 해당 요청을 지도 타일 서비스로 전달한다.
3. 지도 타일 서비스는 클라이언트의 위치와 확대 수준을 입력으로 삼아 9개의 타일 URL을 계산한 다음 클라이언트에 반환한다. 표시할 타일 하나와 8개의 주변 타일이 응답에 포함된다.
4. 모바일 클라이언트는 해당 타일을 CDN을 통해 다운로드 한다.

## 3단계: 상세 설계

### 위치 서비스

사용자 위치 데이터 저장에는 키-값 저장소를 활용한다. 초당 백만 건의 위치 정보 업데이트가 발생한다는 점을 감안하면 쓰기 연산 지원에 탁월한 NoSQL 키-값 데이터베이스가 적합하다.

사용자 위치는 계속 변화해 변경되고 나면 이전 정보는 바로 무용해지기에 일관성보다 가용성이 더 중요하다.

사용자 위치는 쓰임새가 다양한데 폐쇄된 도로를 감지할 수 있고 신설된 도로를 확인할 수 있어 교통 현황을 파악하는데 역할을 할 수 있다. 이런 기록을 하기 위해 카프카와 같은 메시지 큐에 로깅한다.

<img width="732" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/1282bf8c-e320-46d7-97cb-0da397d05484">

### 지도 표시

지도는 위에 말한 두가지 방법있는데, 첫번째는 클라이언트의 위치, 현재 클라이언트가 보는 지도의 확대 수준에 근거해 필요한 지도 타일을 즉석으로 만드는 방안이고 두번째는 확대 수준별로 미리 만들어 둔 지도 타일을 클라이언트에 전달하기만 하는 방법이 있다.

위에서 말한대로 첫번째 방법은 큰 단점이 있어 두번째 방법으로 해야한다.

### 경로 안내 서비스

<img width="619" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/a83d34bf-50b8-4011-a521-232594e64f88">

**지오 코딩 서비스**

주소를 위도와 경도 쌍으로 바꿔주는 서비스가 필요하다. 경로 안내 서비스는 이 서비스를 호출하여 출발지와 목적지 주소를 위도/경도 쌍으로 변환한 뒤 추후 다른 서비스 호출에 이용한다.

### **경로 계획 서비스**

현재 교통 상황과 도로 상태에 입각하여 이동 시간 측면에서 최적화된 경로를 제안하는 역할 담당

**최단 경로 서비스**

출발지와 목적지 위도/경도를 입력으로 받아 k개 최단 경로를 반환하는 서비스다. 도로 상황은 고려하지 않는다.

**예상 도착 시간 서비스**

최단 경로 목록을 수신하면 예상 도착 시간 서비스를 호출하여 그 경로 각각에 대한 소요 시간 추정치를 구한다.

기계 학습을 활용해 현재 교통 상황 및 과거 이력에 근거하여 예상 도착 시간은 계산한다.

**순위 결정 서비스**

ETA 예상치를 구하고 나면 순위 결정 서비스에 관련 정보를 모두 전달하여 사용자가 정의한 필터링 조건을 적용한다. 유료도로 제외, 고속도로 제외 등

## 4단계: 마무리

<img width="524" alt="image" src="https://github.com/Jammini/TIL/assets/59176149/1b94cb28-e9e3-4cfa-83de-3221561ef72b">
